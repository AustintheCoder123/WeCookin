<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<link rel="stylesheet" href="../static/style.css">
<link rel="stylesheet" href="style.css">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div class="popup"> 
        <div class="userPreferences" id="userPrefs">
            <button id="closeButton" onclick="closeSettings()">x</button>

            <div class="restrictions" id="restrictionItems">
                <div class="restrictionItem">
                    <h3 id="allergensHeader">Allergens</h3>
                </div>

                <div class="restrictionItem">
                    <input type="checkbox" value="Vegetarian">
                    <label for="vegetarian">Vegetarian</label>
                </div>

                <div class="restrictionItem">
                    <input type="checkbox" value="Vegan">
                    <label for="vegan">Vegan</label>
                </div>

                <div class="restrictionItem">
                    <input type="checkbox" value="Halal">
                    <label for="halal">Halal</label>
                </div>

                <div class="restrictionItem">
                    <input type="checkbox" value="Kosher">
                    <label for="kosher">Kosher</label>
                </div>          
            </div>

            <div id="otherRestrictionBox">
                <label>Other:</label>
                <input id="otherRestriction">
            </div>

            <div class="allergens" id="allergenItems">
                <div class="allergenItem">
                    <h3 id="restrictionsHeader">Restrictions</h3>
                </div>

                <div class="allergenItem">
                    <input type="checkbox" value="Gluten Free">
                    <label for="glutenFree">Gluten Free</label>
                </div>

                <div class="allergenItem">
                    <input type="checkbox" value="No Dairy">
                    <label for="noDairy">No Dairy</label>
                </div>

                <div class="allergenItem">
                    <input type="checkbox" value="No Nuts">
                    <label for="noNuts">No Nuts</label>
                </div>
            </div>

            <div id="otherAllergenBox">
                <label>Other:</label>
                <input id="otherAllergen">
            </div>
            
        </div>

    </div>

    <div id="wholePage">
<!-- div for bookmark bar -->
        <div id="bookmarkBar">
            <h2>Bookmarks</h2>
            <p onclick="closeBookmark()" id="closeBtn">Close</p>
            <div class="bookmarkRecipe">
            </div>
        </div>


        <div class="mainRecipePage" id="mainRecipePage">
            <!-- This div holds the differently-colored bar at the top of the website, also holds the input bar for restrictions and the settings button -->
            <div class="options" id="options">
                <button onclick="openBookmark()">Bookmarks</button>
                <button onclick="saveRecipe()"> Save Recipe</button>
                <input id="restrictionsPrompt" placeholder="Dietary restrictions here!">
                <button onclick="openSettings()">settings</button>
            </div>

            <!-- This div holds all the things related to the main recipe -->
            <div class="recipeBody">
                
                <div id = "mainRecipeName">
                        <h1>Burger</h1>
                </div>
                
                <div id = "mainRecipeTime">
                    <p>1000000 min</p>
                </div>

                <div id="mainRecipeNutrition">
                    <div class="nutritionItem">
                        <p>Nutrition</p>
                    </div>
                </div>

                <!-- <img src="../static/pngtree-vegan-friendly-label-png-png-image_5698160.png"> -->
                <!-- <img src="../statc/gluten-free-logo-png_seeklogo-530821.png"> -->
                <div class="flexContainer">
                    <div id="box1">
                        <div id="mainRecipeDescription">
                            <p>Description</p>
                        </div>
                    </div>
                    <div id="box2">
                        <div id="mainRecipeIngredients">
                            <div class = "mainRecipeIngredientItem">
                                <p>Ingredients</p>
                            </div>  
                        </div>
                    </div>
                </div>
                
                <div id="mainRecipeInstructions">
                    <div class = "recipeInstructions">
                        <p>Instructions</p>
                    </div>          
                </div>
                

            </div>

            <!-- the div for the search bar and send button -->
            <div class="textboxDiv">
                <input id="foodPrompt" placeholder="Start making recipes!" >
                <button id="createRecipeButton" onclick="createRecipe()">â†‘</button>
            </div>
        </div>
    </div>

</body>

<script>
    window.currentRecipe;
    window.recipeDict = {};
    window.settingsDict = {};


    async function createRecipe(){
        let createButton = document.getElementById("createRecipeButton");
        let foodPrompt = document.getElementById("foodPrompt");
        let foodRecipe = foodPrompt.value;
        foodPrompt.value = "";

        if (foodRecipe == "")
            return;

        let restrictions = document.getElementById("restrictionsPrompt").value;

        recipe = await pywebview.api.create_recipe(foodRecipe, restrictions);
        let optionString = `This is the users dietary restrictions and preferences: ${settingsDict["allergens"]} and ${settingsDict["restrictions"]}.`;
        let combinedRestrictions = `${optionString} Also these are the users special requests for recipes: ${restrictions}.`;

        console.log(restrictions);
        createButton.disabled = true;
        recipe = await pywebview.api.create_recipe(combinedRestrictions, foodRecipe);

        recipe = await pywebview.api.create_recipe(foodRecipe, combinedRestrictions);
        window.currentRecipe = recipe;
        setRecipe(recipe);
        createButton.disabled = false;
    }

    function saveRecipe(){
        if (typeof window.recipeDict == "undefined"){
            window.recipeDict = {};
        }

        window.recipeDict[window.currentRecipe["name"]] = window.currentRecipe;
        newBookmark(currentRecipe);

        pywebview.api.save_recipe(recipeDict);
    }

    function setRecipe(displayRecipe){
        if(displayRecipe){
            document.getElementById("mainRecipeName").textContent = displayRecipe.name;
            document.getElementById("mainRecipeTime").textContent = displayRecipe.time;

            // NUTRITION INFORMATION
            while (document.getElementById("mainRecipeNutrition").lastElementChild){
                document.getElementById("mainRecipeNutrition").removeChild(document.getElementById("mainRecipeNutrition").lastElementChild);
            }
            let nutrition = displayRecipe.nutrition;

            createNutrientItem("Calories", nutrition.totalCalories);
            createNutrientItem("Cholesterol", nutrition.cholesterol);
            createNutrientItem("Sodium", nutrition.sodium);
            createNutrientItem("Servings", nutrition.servingsPerRecipe);
            createNutrientItem("Fat", nutrition.totalFat);
            createNutrientItem("Saturated fat", nutrition.saturatedFat);
            

            document.getElementById("mainRecipeDescription").textContent = displayRecipe.desc;

            // INGREDIENTS
            while (document.getElementById("mainRecipeIngredients").lastElementChild){
                document.getElementById("mainRecipeIngredients").removeChild(document.getElementById("mainRecipeIngredients").lastElementChild);
            }
            for (let ingredient = 0; ingredient < displayRecipe.ingredients.length; ingredient++){
                createIngredients(displayRecipe.ingredients[ingredient]);
            }
            
            // INSTRUCTIONS
            while (document.getElementById("mainRecipeInstructions").lastElementChild){
                document.getElementById("mainRecipeInstructions").removeChild(document.getElementById("mainRecipeInstructions").lastElementChild);
            }
            for (let instruction = 0; instruction < displayRecipe.instructions.length; instruction++){
                createInstructions(displayRecipe.instructions[instruction]);
            }
        }
    }

    function createNutrientItem(nutrient, value) {
        let nutritionDiv = document.createElement("div");
        let nutritionText = document.createElement("p");

        nutritionText.innerText = nutrient + ": " + value;
        nutritionDiv.className = "nutritionItem";

        document.getElementById("mainRecipeNutrition").appendChild(nutritionDiv);
        nutritionDiv.appendChild(nutritionText);
    }
    
    function createInstructions(instruction){
        let instructionDiv = document.createElement("div");
        let instructionText = document.createElement("p");

        instructionDiv.className = "recipeInstructions"

        instructionText.innerText = instruction;
        instructionDiv.appendChild(instructionText);

        document.getElementById("mainRecipeInstructions").appendChild(instructionDiv);
    }

    function createIngredients(ingredient){
        let ingredientDiv = document.createElement("div");
        let ingredientText = document.createElement("p");

        ingredientDiv.className = "mainRecipeIngredientItem";

        ingredientText.innerText = ingredient;
        ingredientDiv.appendChild(ingredientText);

        document.getElementById("mainRecipeIngredients").appendChild(ingredientDiv);
    }

    function recipeFromBar(name){
        grabbed = window.recipeDict[name];
        setRecipe(grabbed);
    }

    function newBookmark(recipe){
        checkDuplicateBookmarks(recipe);

        let bookmarkDiv = document.createElement("div");
        let textDiv = document.createElement("div");
        let buttonDiv = document.createElement("div");
        let bookmarkText = document.createElement("h3");
        let bookmarkDelete = document.createElement("button");

        bookmarkText.addEventListener('click', function () {
            setRecipe(recipeDict[bookmarkText.innerText]);
        });


        bookmarkText.innerText = recipe.name;
        bookmarkText.className = "savedRecipe";
        bookmarkDiv.className = "bookmarkRecipe";
        bookmarkDiv.value = recipe.name;
        bookmarkDelete.className = "deleteBookmark";

        bookmarkDelete.innerText = "X";

        bookmarkDelete.onclick = function(){
            checkDuplicateBookmarks(recipe);
            delete recipeDict[recipe.name];
            pywebview.api.save_recipe(recipeDict);
        };


        document.getElementById("bookmarkBar").appendChild(bookmarkDiv);
        bookmarkDiv.appendChild(textDiv);
        bookmarkDiv.appendChild(buttonDiv);
        textDiv.appendChild(bookmarkText);
        buttonDiv.appendChild(bookmarkDelete);

    }

    function checkDuplicateBookmarks(recipe){
        const bookmarks = document.getElementsByClassName("bookmarkRecipe");

        for (let i = 0; i < bookmarks.length; i++) {
            if(bookmarks[i].value==recipe.name){
                bookmarks[i].remove();
            }
        }
    }

    function openBookmark() {
        document.getElementById("bookmarkBar").style.width = "19%";
        document.getElementById("mainRecipePage").style.width = "80%";
        document.getElementById("options").style.paddingLeft = "70%";
    }

    function closeBookmark(){
        document.getElementById("bookmarkBar").style.width = "0";
        document.getElementById("mainRecipePage").style.width = "100%";
        document.getElementById("options").style.paddingLeft = "74%";
    }

    function openSettings(){
        let settings = document.getElementById("userPrefs");
        settings.style.display = "block";
    }
    function closeSettings(){
        let settings = document.getElementById("userPrefs");
        settings.style.display = "none";
        setAllergens();
        setRestrictions();

        pywebview.api.save_settings(settingsDict);
    }

    function addRestriction(item){
        let restrictionItemDiv = document.createElement("div");
        let newRestrictionBox = document.createElement("input");
        let newRestrictionLabel = document.createElement("label");

        restrictionItemDiv.className = "restrictionItem";
        newRestrictionBox.type = "checkbox";
        newRestrictionBox.value = item;

        newRestrictionLabel.textContent = item;

        
        document.getElementById("restrictionItems").appendChild(restrictionItemDiv);
        restrictionItemDiv.appendChild(newRestrictionBox);
        restrictionItemDiv.appendChild(newRestrictionLabel);

    }

    function addAllergen(item){
        let allergenItemDiv = document.createElement("div");
        let newAllergenBox = document.createElement("input");
        let newAllergenLabel = document.createElement("label");

        allergenItemDiv.className = "allergenItem";
        newAllergenBox.type = "checkbox";
        newAllergenBox.value = item;

        newAllergenLabel.textContent = item;

        document.getElementById("allergenItems").appendChild(allergenItemDiv);
        allergenItemDiv.appendChild(newAllergenBox);
        allergenItemDiv.appendChild(newAllergenLabel);
    }

    function setAllergens(){
        let buttonsInDiv = document.getElementById("allergenItems").querySelectorAll("input");
        let allergensList = [];

        buttonsInDiv.forEach(element => {
            if(element.checked){
                allergensList.push(element.value);
            }
        });

        settingsDict["allergens"] = allergensList.join(", ");
    }

    function setRestrictions(){
        let buttonsInDiv = document.getElementById("restrictionItems").querySelectorAll("input");
        let restrictionsList = [];

        buttonsInDiv.forEach(element => {
            if(element.checked){
                restrictionsList.push(element.value);
            }
        });

        settingsDict["restrictions"] = restrictionsList.join(", ");
    }

    function loadAllergens(){
        let allergenList = settingsDict["allergens"].split(", ");
        let buttonsInDiv = document.getElementById("allergenItems").querySelectorAll("input");

        buttonsInDiv.forEach(element => {
            for(let i =0;i<allergenList.length; i++){
                if(element.value == allergenList[i]){
                    element.checked = true;
                }
            }    
        });
    }

    function loadRestrictions(){
        let restrictionList = settingsDict["restrictions"].split(", ");
        let buttonsInDiv = document.getElementById("restrictionItems").querySelectorAll("input");

        let temp = 0;
        buttonsInDiv.forEach(element => {
            for(let i =0+temp;i<restrictionList.length; i++){
                if(element.value == restrictionList[i]){
                    element.checked = true;
                    temp++;
                }
            }    
        });
        temp =0;
    }


    //Event Listeners------------------------------------------

    let restrictionsInput = document.getElementById("otherRestriction");
    let allergensInput = document.getElementById("otherAllergen");
    let recipeInput = document.getElementById("foodPrompt");

    restrictionsInput.addEventListener("keypress", function (event){
        if(event.key=="Enter"){
            event.preventDefault();
            addRestriction(restrictionsInput.value);
            restrictionsInput.value = "";
        }
    });

    allergensInput.addEventListener("keypress", function (event){
        if(event.key=="Enter"){
            event.preventDefault();
            addAllergen(allergensInput.value);
            allergensInput.value = "";
        }
    });

    recipeInput.addEventListener("keypress", function (event){
        if(event.key=="Enter"){
            event.preventDefault();
            createRecipe();
            recipeInput.value = "";      
        }
    });




    window.addEventListener('pywebviewready', async () => {
        if (pywebview.api.init) {
            await pywebview.api.init();
        }
        recipeDict = await pywebview.api.load_recipes();
        settingsDict = await pywebview.api.load_settings();

        loadAllergens();
        loadRestrictions();

        for (const key in recipeDict){
            newBookmark(recipeDict[key]);
        }
    });

    


</script>
</html>